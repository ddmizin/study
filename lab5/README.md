# Лабораторная работа 5

ITMO Loops

## Задача

Реализовать программу, способную считывать текстовое описание композиции в формате **ITMO Loops** и генерировать по нему `.wav` файл.

```sh
./itmoloops score.txt music.wav
```

Программа должна:

1. Прочитать файл с описанием композиции.

2. Построить внутреннюю модель трека (инструменты, эффекты, паттерны, временную структуру).

3. Сгенерировать одноканальный звуковой сигнал и записать корректный WAV-файл с [частотой дискретизации](https://en.wikipedia.org/wiki/Sampling_(signal_processing)#Sampling_rate) 44.1 kHz и [глубиной](https://en.wikipedia.org/wiki/Audio_bit_depth) 16 бит.

## Формат

Треки заданы в [DSL](https://en.wikipedia.org/wiki/Domain-specific_language), специально разработанном для **ITMO Loops**.

- Формат **ITMO Loops** может содержать комментарии. Комментарии начинаются с `#`, и продолжаются до конца строки.

- Табуляция и перенос строк не влияют на содержание композиции.

```
bpm 120

instrument sax sampler
    sample=./samples/sax.wav
    root=C5
    loop=8893,9229
    attack=0.001
    release=0.05
    effect echo delay=0.3 decay=0.2
end

pattern main resolution 8
    00 sax D5  2 50
    05 sax E5  2 50
    08 sax F5  2 50
    13 sax G5  2 50
    16 sax E5  4 50
    23 sax C5  2 50
    28 sax D5  8 50
end
```
[lick.webm](https://github.com/user-attachments/assets/7c95400a-e7a6-4870-9f5a-72cf58f91462)

Вы можете найти больше примеров композиций в формате **ITMO Loops** в директории [examples/](./examples/). Используйте их для проверки работоспособности вашей программы.

### Время и паттерны (`pattern`)

```
pattern pattern2 resolution 8
    00 inst C5  2 50
end

pattern pattern1 resolution 8
    02 @pattern2
    00 inst C5  2 50
end

pattern main 1
    04 inst C5  8 50
    00 @pattern1
end
```

Паттерн - это именованный блок команд. Паттерны позволяют удобно группировать повторяющиеся действия, по аналогии с функциями в C++. Команды в паттерне могут быть записаны в любом порядке, не обязательно хронологически.

При использовании паттерна (`@name`) он "вызывается" в указанное время. Паттерн может использоваться только после его объявления.

Паттерн с именем `main` - это основной паттерн композиции. С него начинатеся воспроизведение. Длина композиции автоматически определяется по концу самой последней ноты в этом паттерне.

Время измеряется в юнитах. Юнит - это фиксированная дробь от одной доли (beat):

- `1 beat` = `60 seconds` / `bpm`
- `1 unit` = `1 beat` / `resolution`

Параметр `resolution` задаётся в объявлении паттерна и определяет, на сколько частей делится одна доля.

Параметр `bpm` задаётся глоблально, один раз в начале файла.

Длительность паттерна и время между нотами в нём фиксированы. При использовании паттерна в разных местах, меняется только его относительное начало.

### Ноты

Ноты задают, когда и что должен сыграть инструмент. Они имеют следующий формат записи:

```
<start> <instrument> <pitch> <duration> <velocity>
```

| Часть        | Пример       | Описание        |
|--------------|--------------|-----------------|
| `start`      | `00`         | Момент начала ноты в юнитах.  |
| `instrument` | `sax`        | Инструмент, на котором будет играться нота. |
| `pitch`      | `C5`         | Высота ноты. |
| `duration`   | `2`          | Продолжительность ноты в юнитах. |
| `velocity`   | `50`         | Относительная громкость ноты от 0 до 100. |

Каждая нота формирует отдельный звуковой сигнал инструмента. Если инструменту даны несколько накладывающихся нот, они звучат одновременно как независимые голоса.

### Инструменты (`instrument`)

```
instrument <name> <type>
    <params...>
    <effects...>
end
```

| Часть        | Пример          | Описание        |
|--------------|-----------------|-----------------|
| `name`       | `my_cool_piano` | Название. |
| `type`       | `sampler`       | Тип (перечислпены ниже). |
| `params...`  |                 | Список пар формата `<ключ>=<значение>`. Доступные ключи зависят от типа инструмента. |
| `effects...` |                 | Список [эффектов](#эффекты). |

Все инструменты имеют [Attack-Release](https://en.wikipedia.org/wiki/Envelope_(music)#ADSR) кривую (без Decay и Sustain), за которую отвечают параметры `attack` и `release`. По умолчанию, они равны `0`.

Также все инструменты поддерживает полифонию: они могут играть несколько нот в один момент времени.

Вам необходимо реализовать 4 инструмента:

#### 1. `sampler`

Загружает файл в формате WAV, и проигрывает его с нужной высотой при помощи ускорения/замедления.

| Параметр  | Пример       | Описание        |
|-----------|--------------|-----------------|
| `sample`  | `./bass.wav` | Путь до файла |
| `root`    | `C5`         | Корневая нота (нота, которой соответствует оригинальный звук в файле). |
| `loop`    | `1233,6735`  | Начало и конец части, которую нужно зациклить. Указана в сэмплах. Может отсутствовать. |
| `attack`  | `0.05`       | Длительность Attack в секундах. |
| `release` | `0.1`        | Длительность Release в секундах. |

> Для изменения высоты звука, его нужно ресэмплировать. Коэффицент ресэмплирования равен отношению частот целевой и корневой ноты.
>
> Например, отношение частот для нот `C6` и `C5` равно 2 (октаве).
>
> Скорость воспроизведения и высота обратно пропорциональны. Если проигрывать только каждый второй сэмпл звука, он станет в два раза короче, и будет звучать на октаву выше.

Проигрывание ограничено длительностью ноты. Если нота заканчивается раньше, чем файл - воспроизведение обрывается.

Сэмплер может иметь циклическую часть (`loop`), при котором часть сэмпла будет повторяться.
В таком случае, сначала один раз проиграется `[0; loop_start)`, затем будет повторяться `[loop_start; loop_end]`.
Если параметр `loop` не указан, файл проигрывается от начала до конца один раз.

#### 2. `square`

[Осциллятор](https://en.wikibooks.org/wiki/Sound_Synthesis_Theory/Oscillators_and_Wavetables) с формой "квадрат".

![](https://github.com/user-attachments/assets/75056162-059f-420f-aaa0-2167e30f501f)

| Параметр  | Пример     | Описание        |
|-----------|------------|-----------------|
| `duty`    | `50`       | [Duty cycle](https://en.wikipedia.org/wiki/Duty_cycle), число от 0 до 100. |
| `attack`  | `0.05`     | Длительность Attack в секундах. |
| `release` | `0.1`      | Длительность Release в секундах. |

#### 3. `sine`, `triangle`

Осцилляторы с формой синусоиды и треугольника.

![](https://github.com/user-attachments/assets/c575870f-f1af-4d25-bd37-1f8d1dc9aede)

| Параметр  | Пример     | Описание        |
|-----------|------------|-----------------|
| `attack`  | `0.05`     | Длительность Attack в секундах. |
| `release` | `0.1`      | Длительность Release в секундах. |

### Эффекты

Эффекты объявляются в блоке инструмента и имеют следующий синтаксис:

```
effect <type> <params...>
```

Они применяются к каждому инструменту отдельно, после суммирования сигналов всех его голосов (нот).
На один инструмент может быть наложено несколько эффектов одновременно - тогда они будут применяться последовательно в порядке объявления.

Вам необходимо реализовать 3 эффекта:

#### 1. `gain`

Изменение громкости. Умножает сигнал на коэффициент.

```
y(t) = gain * x(t)
```

| Параметр | Пример | Описание        |
|----------|--------|-----------------|
| `gain`   | `0.4`  | Коэфициент изменения сигнала. |

#### 2. `echo`

[Эхо](https://ptolemy.berkeley.edu/eecs20/week7/echo.html). Повторяет сигнал с задержкой и затуханием.

```
y(t) = x(t) + decay * x(t - delay)
```

| Параметр | Пример | Описание        |
|----------|--------|-----------------|
| `delay`  | `0.4`  | Задержка перед повторением сигнала. Указана в секундах. |
| `decay`  | `0.2`  | Коэффициент затухания. `0.1` => сигнал будет тише в 10 раз. |

#### 3. `tremolo`

Модуляция громкости по времени. Периодически делает звук тише/громче, изменяя амплитуду сигнала по синусоидальному закону.

```
y(t) = x(t) * (1 - depth + depth * sin(2 * pi * freq * t))
```

| Параметр | Пример | Описание        |
|----------|--------|-----------------|
| `freq`   | `100`  | Частота модуляции. |
| `depth`  | `0.5`  | Коэффицент изменения сигнала. |

## Немного теории про звук

- **Звук** - это изменяющийся во времени сигнал. В цифровом виде он представлен последовательностью чисел, каждое из которых показывает амплитуду в определённый момент времени. Частота определяет высоту звука. Амплитуда определяет громкость.

- **Ноты** - это частоты. Для вашего удобства, в корне репозитория прикреплён [файл](./notes.txt), содержащий названия нот и частоты, соответствующие им.

- **Инструмент** - функция, которая генерирует звуковой сигнал из потока нот во времени.

- **Эффект** - функция, которая преобразует звуковой сигнал.

В нашей лабораторной пайплайн рендеринга выглядит следующим образом:

```
Ноты -> Инструмент -> Звук -> Эффект1 -> Эффект2 -> ... }
Ноты -> Инструмент -> Звук -> Эффект1 -> Эффект2 -> ... } Финальный звук
Ноты -> Инструмент -> Звук -> Эффект1 -> Эффект2 -> ... }
```

## NB

- В WAV, звук может быть закодирован разными способами и с разной частотой дискретизации. Вам достаточно реализовать чтение и запись WAV файла в моно, 44.1kHz, 16-bit.

- Ваша реализация должна быть расширяемой и легко поддерживать добавление новых инструметов и эффектов.

- Подумайте, как правильно разделить отвественности и этапы генерации.

## Материалы

1. [Digital Audio - Wikipedia](https://en.wikipedia.org/wiki/Digital_audio)

2. [WAV - Wikipedia](https://en.wikipedia.org/wiki/WAV)

3. [Wave File Specifications - McGill University](https://mmsp.ece.mcgill.ca/Documents/AudioFormats/WAVE/WAVE.html)

4. [Oscillators and wavetables - Wikibooks](https://en.wikibooks.org/wiki/Sound_Synthesis_Theory/Oscillators_and_Wavetables)

5. [Understanding sound - Wikibooks](https://en.wikibooks.org/wiki/Digital_Music_Composition/Understanding_Sound)

5. [What is Sampling? - YouTube, Berkley Online](https://youtu.be/sDnw4FFTb6Q)

6. [Factory method pattern - Wikipedia](https://en.wikipedia.org/wiki/Factory_method_pattern)

## Теормин

1. ООП. Абстракция и Инкапсуляция
2. Классы. Специальные методы
3. Классы. Перегрузки операторов
4. ООП. Наследование
5. ООП. Полиморфизм
6. RAII
7. Виртуальные функции

## Deadline

| deadline | date | coeff | branch |
|----------|-----------------|-------|------------|
| 0 | 15.12.25 23:59 | 1.0 | deadline_0 |
| 1 | 22.12.25 23:59 | 0.8 | deadline_1 |
| 2 | 31.12.25 23:59 | 0.65 | deadline_2 |
| 3 | 07.01.26 00:00 | 0.5 | deadline_3 |

Максимальное количество баллов - 12

